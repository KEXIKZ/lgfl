<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>L.G.F.L</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@400&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0c0f14;
      --surface:#121622;
      --surface2:#171c2b;
      --surface3:#1c2233;
      --text:#e7e9f1;
      --outline:rgba(231,233,241,.10);
      --outline2:rgba(231,233,241,.18);
      --primary:#8ab4ff;
      --danger:#ff7a7a;
      --ok:#65d48e;
      --admin:#bb86fc;
      --news:#ffb86b;
      --message:#50fa7b;
      --r-xl:22px;
      --r-lg:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-100%);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes gradientFlow {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
    
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }
    
    /* –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π */
    .animate-fade-up {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .animate-fade-left {
      animation: fadeInLeft 0.6s ease-out;
    }
    
    .animate-fade-right {
      animation: fadeInRight 0.6s ease-out;
    }
    
    .animate-scale {
      animation: scaleIn 0.5s ease-out;
    }
    
    .animate-slide-down {
      animation: slideInDown 0.5s ease-out;
    }
    
    .topbar {
      animation: slideInDown 0.5s ease-out;
    }
    
    .brand {
      animation: fadeInLeft 0.6s ease-out;
    }
    
    .nav {
      animation: fadeInRight 0.6s ease-out;
    }
    
    .card {
      animation: fadeInUp 0.6s ease-out;
      animation-fill-mode: both;
    }
    
    .leftcol .card:nth-child(1) { animation-delay: 0.1s; }
    .leftcol .card:nth-child(2) { animation-delay: 0.2s; }
    .leftcol .card:nth-child(3) { animation-delay: 0.3s; }
    .leftcol .card:nth-child(4) { animation-delay: 0.4s; }
    .leftcol .card:nth-child(5) { animation-delay: 0.5s; }
    
    .rightcol .card {
      animation: fadeInRight 0.6s ease-out;
      animation-delay: 0.3s;
      animation-fill-mode: both;
    }
    
    .post {
      animation: fadeInUp 0.5s ease-out;
      animation-fill-mode: both;
    }
    
    .post:nth-child(1) { animation-delay: 0.1s; }
    .post:nth-child(2) { animation-delay: 0.2s; }
    .post:nth-child(3) { animation-delay: 0.3s; }
    .post:nth-child(4) { animation-delay: 0.4s; }
    .post:nth-child(5) { animation-delay: 0.5s; }
    
    .btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .avatar-container {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .avatar-container:hover {
      transform: scale(1.05) rotate(5deg);
      border-color: var(--message);
    }
    
    .logo {
      transition: all 0.3s ease;
    }
    
    .logo:hover {
      transform: rotate(360deg);
    }
    
    .brand__name {
      background: linear-gradient(90deg, var(--primary), var(--message), var(--primary));
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientFlow 3s linear infinite;
    }
    
    .toast {
      animation: fadeInUp 0.3s ease-out;
    }
    
    .dialog-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .dialog-item:hover {
      transform: translateX(5px);
      background: var(--surface3);
    }
    
    .dialog-item.active {
      animation: pulse 2s infinite;
    }
    
    .message-bubble {
      transition: all 0.3s ease;
      animation: fadeInUp 0.3s ease-out;
    }
    
    .message-bubble.sent:hover {
      transform: scale(1.02) translateX(-2px);
    }
    
    .message-bubble.received:hover {
      transform: scale(1.02) translateX(2px);
    }
    
    .load-more-btn {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .load-more-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to right,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.1) 50%,
        rgba(255, 255, 255, 0) 100%
      );
      transform: rotate(30deg);
      animation: shimmer 3s infinite;
    }
    
    .load-more-btn:hover {
      transform: scale(1.02);
      border-color: var(--primary);
    }
    
    .user-search-result {
      transition: all 0.3s ease;
    }
    
    .user-search-result:hover {
      transform: translateX(5px);
      background: var(--surface3);
    }
    
    .badge {
      transition: all 0.2s ease;
    }
    
    .badge:hover {
      transform: scale(1.1);
    }
    
    .typing-indicator {
      animation: fadeInUp 0.3s ease-out;
    }
    
    .typing-dot {
      animation: typing 1.4s infinite;
    }
    
    /* –≠—Ñ—Ñ–µ–∫—Ç –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-shimmer {
      background: linear-gradient(
        90deg,
        var(--surface2) 25%,
        var(--surface3) 50%,
        var(--surface2) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    .content > * {
      animation: fadeInUp 0.6s ease-out;
    }
    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      letter-spacing:.2px;
      overflow-x: hidden;
    }

    .app{min-height:100%;display:flex;flex-direction:column}

    .topbar{
      position:sticky;top:0;z-index:10;
      background:rgba(12,15,20,.86);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--outline);
    }
    .topbar__inner{
      max-width:980px;margin:0 auto;padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:160px}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background:var(--surface2);
      border:1px solid var(--outline2);
      display:grid;place-items:center;
      box-shadow:var(--shadow);
      transition: transform 0.3s ease;
    }
    .logo .material-symbols-rounded{
      font-variation-settings:"FILL" 1,"wght" 500,"GRAD" 0,"opsz" 24;
      color:var(--primary);font-size:20px;line-height:1;
    }
    .brand__name{font-weight:800;letter-spacing:1px}

    .nav{display:flex;align-items:center;gap:8px}

    .content{
      max-width:980px;margin:0 auto;padding:16px;width:100%;
      display:grid;grid-template-columns:1fr 320px;gap:14px;
    }
    @media (max-width:880px){ .content{grid-template-columns:1fr} .rightcol{order:-1} }

    .card{
      background:var(--surface);
      border:1px solid var(--outline);
      border-radius:var(--r-xl);
      padding:14px;
      box-shadow:var(--shadow);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.4);
      border-color: var(--primary);
    }
    
    .card--flat{box-shadow:none;background:var(--surface2)}
    .card__title{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;
    }
    .card__title h2{font-size:14px;margin:0;font-weight:800;letter-spacing:.4px}

    .row{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}

    .btn{
      appearance:none;
      border:1px solid var(--outline2);
      background:var(--surface3);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:750;
      transition:transform .05s ease,border-color .12s ease,background .12s ease,opacity .12s ease;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;white-space:nowrap;
    }
    .btn:hover{border-color:rgba(138,180,255,.35)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .btn--primary{background:rgba(138,180,255,.16);border-color:rgba(138,180,255,.35)}
    .btn--ghost{background:transparent;border-color:var(--outline)}
    .btn--danger{background:rgba(255,122,122,.12);border-color:rgba(255,122,122,.26)}
    .btn--admin{background:rgba(187,134,252,.16);border-color:rgba(187,134,252,.35)}
    .btn--news{background:rgba(255,184,107,.16);border-color:rgba(255,184,107,.35)}
    .btn--message{background:rgba(80,250,123,.16);border-color:rgba(80,250,123,.35)}

    .icon{
      font-family:"Material Symbols Rounded";
      font-weight:normal;font-style:normal;font-size:18px;line-height:1;
      letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;
      -webkit-font-feature-settings:'liga';-webkit-font-smoothing:antialiased;
    }

    .input,.textarea{
      width:100%;
      background:var(--surface3);
      border:1px solid var(--outline);
      color:var(--text);
      border-radius:var(--r-lg);
      padding:10px 12px;
      outline:none;
      transition:border-color .12s ease, box-shadow .12s ease, transform 0.2s ease;
    }
    .textarea{min-height:110px;resize:vertical}
    .input:focus,.textarea:focus{
      border-color:rgba(138,180,255,.35);
      box-shadow:0 0 0 3px rgba(138,180,255,.12);
      transform: scale(1.02);
    }
    .label{font-size:12px;opacity:.9;margin-bottom:6px}

    .feed{display:flex;flex-direction:column;gap:12px}
    .post{
      background:var(--surface2);
      border:1px solid var(--outline);
      border-radius:var(--r-xl);
      padding:14px;
      transition: all 0.3s ease;
    }
    
    .post:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      border-color: var(--primary);
    }
    
    .post--news{
      border-left:4px solid var(--news);
      background:rgba(255,184,107,.05);
    }
    .post--message{
      border-left:4px solid var(--message);
      background:rgba(80,250,123,.05);
    }
    .post__head{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-bottom:10px;
    }
    .post__author{font-weight:900;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 9px;border-radius:999px;
      font-size:12px;border:1px solid var(--outline2);
      background:rgba(255,255,255,.04);
      opacity:.95;
    }
    .badge--pin{
      border-color:rgba(138,180,255,.35);
      background:rgba(138,180,255,.10);
      color:var(--primary);
    }
    .badge--time{
      border-color:rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      font-size:11px;
    }
    .badge--admin{
      border-color:rgba(187,134,252,.35);
      background:rgba(187,134,252,.10);
      color:#bb86fc;
    }
    .badge--bot{
      border-color:rgba(138,180,255,.35);
      background:rgba(138,180,255,.10);
      color:var(--primary);
    }
    .badge--news{
      border-color:var(--news);
      background:rgba(255,184,107,.10);
      color:var(--news);
    }
    .badge--message{
      border-color:var(--message);
      background:rgba(80,250,123,.10);
      color:var(--message);
    }
    .badge--leaguefun{
      border-color:#50fa7b;
      background:rgba(80,250,123,.10);
      color:#50fa7b;
    }
    .post__date{font-size:12px;opacity:.8}
    .post__text{white-space:pre-wrap;word-break:break-word;font-size:14px;margin-top:8px;}

    .hr{height:1px;background:var(--outline);margin:12px 0}
    .hidden{display:none !important}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(18,22,34,.92);
      border:1px solid var(--outline2);
      border-radius:999px;
      padding:10px 14px;
      display:none;align-items:center;gap:10px;
      box-shadow:var(--shadow);
      max-width:min(92vw,760px);
      z-index:50;
    }
    .toast.show{display:flex}

    .time-details{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:6px;
      font-size:11px;
      color:#9aa1b3;
    }

    .admin-section{
      background:rgba(187,134,252,.05);
      border:1px solid rgba(187,134,252,.2);
      border-radius:var(--r-lg);
      padding:10px;
      margin-bottom:12px;
      transition: all 0.3s ease;
    }
    
    .admin-section:hover {
      background:rgba(187,134,252,.1);
      border-color:rgba(187,134,252,.3);
    }

    .news-section{
      background:rgba(255,184,107,.05);
      border:1px solid rgba(255,184,107,.2);
      border-radius:var(--r-lg);
      padding:10px;
      margin-bottom:12px;
      transition: all 0.3s ease;
    }
    
    .news-section:hover {
      background:rgba(255,184,107,.1);
      border-color:rgba(255,184,107,.3);
    }

    .message-section{
      background:rgba(80,250,123,.05);
      border:1px solid rgba(80,250,123,.2);
      border-radius:var(--r-lg);
      padding:10px;
      margin-bottom:12px;
      transition: all 0.3s ease;
    }
    
    .message-section:hover {
      background:rgba(80,250,123,.1);
      border-color:rgba(80,250,123,.3);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è RTDB –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
    .rtdb-viewer{
      background:var(--surface2);
      border:1px solid var(--outline);
      border-radius:var(--r-lg);
      padding:12px;
      margin-top:16px;
      max-height:400px;
      overflow:auto;
    }
    .rtdb-item{
      border-bottom:1px solid var(--outline);
      padding:8px 0;
      font-family:monospace;
      font-size:12px;
      transition: all 0.2s ease;
    }
    
    .rtdb-item:hover {
      background: var(--surface3);
      padding-left: 8px;
    }
    
    .rtdb-key{
      color:var(--primary);
      font-weight:bold;
    }
    .rtdb-value{
      color:var(--ok);
      margin-left:16px;
      word-break:break-all;
    }
    .json-view{
      background:var(--surface3);
      border-radius:var(--r-lg);
      padding:12px;
      font-family:monospace;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      color:var(--primary);
    }

    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:16px;
      border-bottom:1px solid var(--outline);
      padding-bottom:8px;
    }
    .tab{
      padding:8px 16px;
      border-radius:999px;
      cursor:pointer;
      background:var(--surface2);
      border:1px solid var(--outline);
      transition: all 0.3s ease;
    }
    .tab:hover {
      background: var(--surface3);
      transform: translateY(-2px);
    }
    .tab.active{
      background:var(--primary);
      color:var(--bg);
      border-color:var(--primary);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
    .user-search-result{
      padding:8px;
      border-radius:var(--r-lg);
      background:var(--surface2);
      margin-bottom:8px;
      cursor:pointer;
      transition: all 0.3s ease;
    }
    .user-search-result:hover{
      background:var(--surface3);
      border-color:var(--primary);
      transform: translateX(5px);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
    .chat-container{
      display:flex;
      flex-direction:column;
      height:600px;
      background:var(--surface2);
      border-radius:var(--r-xl);
      overflow:hidden;
      animation: scaleIn 0.5s ease-out;
    }
    
    .chat-header{
      padding:16px;
      background:var(--surface3);
      border-bottom:1px solid var(--outline);
      display:flex;
      align-items:center;
      gap:12px;
      animation: slideInDown 0.4s ease-out;
    }
    
    .chat-header-info{
      flex:1;
    }
    
    .chat-header-name{
      font-weight:bold;
      font-size:16px;
    }
    
    .chat-header-status{
      font-size:12px;
      opacity:0.7;
      display:flex;
      align-items:center;
      gap:4px;
    }
    
    .status-online{
      color:var(--message);
    }
    
    .status-offline{
      color:var(--danger);
    }
    
    .chat-messages{
      flex:1;
      overflow-y:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .message-wrapper{
      display:flex;
      margin-bottom:8px;
      animation: fadeInUp 0.3s ease-out;
    }
    
    .message-wrapper.sent{
      justify-content:flex-end;
    }
    
    .message-wrapper.received{
      justify-content:flex-start;
    }
    
    .message-bubble{
      max-width:70%;
      padding:10px 14px;
      border-radius:18px;
      position:relative;
      word-break:break-word;
    }
    
    .message-bubble.sent{
      background:var(--primary);
      color:var(--bg);
      border-bottom-right-radius:4px;
    }
    
    .message-bubble.received{
      background:var(--surface3);
      border-bottom-left-radius:4px;
    }
    
    .message-time{
      font-size:10px;
      opacity:0.7;
      margin-top:4px;
      text-align:right;
    }
    
    .message-status{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      margin-top:2px;
    }
    
    .message-status.read{
      color:var(--message);
    }
    
    .chat-input-area{
      padding:16px;
      background:var(--surface3);
      border-top:1px solid var(--outline);
      animation: fadeInUp 0.4s ease-out;
    }
    
    .chat-input-wrapper{
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    
    .chat-input{
      flex:1;
      background:var(--surface2);
      border:1px solid var(--outline);
      border-radius:24px;
      padding:12px 16px;
      color:var(--text);
      resize:none;
      max-height:120px;
      min-height:40px;
      font-family:inherit;
    }
    
    .chat-input:focus{
      outline:none;
      border-color:var(--message);
    }
    
    .chat-emoji-picker{
      display:flex;
      gap:4px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    
    .emoji-btn{
      background:var(--surface2);
      border:1px solid var(--outline);
      border-radius:20px;
      padding:4px 8px;
      font-size:14px;
      cursor:pointer;
      transition: all 0.3s ease;
    }
    
    .emoji-btn:hover{
      background:var(--surface3);
      border-color:var(--message);
      transform: scale(1.1);
    }
    
    .chat-actions{
      display:flex;
      gap:4px;
    }
    
    .dialog-item{
      cursor:pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .dialog-item:hover{
      background:var(--surface3);
      transform: translateX(5px);
    }
    
    .dialog-item.active{
      border-left:4px solid var(--message);
    }
    
    .unread-badge{
      background:var(--message);
      color:var(--bg);
      border-radius:20px;
      padding:2px 8px;
      font-size:12px;
      margin-left:8px;
      animation: pulse 2s infinite;
    }
    
    .typing-indicator{
      display:flex;
      gap:4px;
      padding:8px 12px;
      background:var(--surface3);
      border-radius:18px;
      width:fit-content;
      margin-bottom:8px;
    }
    
    .typing-dot{
      width:8px;
      height:8px;
      background:var(--text);
      border-radius:50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2){ animation-delay:0.2s; }
    .typing-dot:nth-child(3){ animation-delay:0.4s; }
    
    @keyframes typing{
      0%,60%,100%{ transform:translateY(0); opacity:0.5; }
      30%{ transform:translateY(-4px); opacity:1; }
    }
    
    .chat-search{
      margin-bottom:16px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫ –∫–∞–∫ –≤ Discord */
    .avatar-container {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid var(--primary);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .avatar-container:hover {
      border-color: var(--message);
      transform: scale(1.05) rotate(5deg);
    }
    
    .avatar-container:hover .avatar-overlay {
      opacity: 1;
    }
    
    .avatar-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .avatar-placeholder {
      width: 100%;
      height: 100%;
      background: var(--surface3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: bold;
      color: var(--primary);
      text-transform: uppercase;
    }
    
    .avatar-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
      color: white;
      font-size: 24px;
    }
    
    .avatar-upload {
      display: none;
    }
    
    .avatar-preview {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 8px;
      border: 2px solid var(--primary);
    }
    
    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-small {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid var(--primary);
      transition: all 0.3s ease;
    }
    
    .avatar-small:hover {
      transform: scale(1.1);
      border-color: var(--message);
    }
    
    .avatar-small img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-small .placeholder {
      width: 100%;
      height: 100%;
      background: var(--surface3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: var(--primary);
    }
    
    .profile-header {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 20px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
    .archive-badge {
      background: var(--surface3);
      color: var(--text);
      border: 1px solid var(--outline2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      margin-left: 8px;
      transition: all 0.2s ease;
    }
    
    .archive-badge:hover {
      background: var(--surface2);
      transform: scale(1.05);
    }
    
    .load-more-btn {
      width: 100%;
      padding: 8px;
      background: var(--surface3);
      border: 1px solid var(--outline);
      border-radius: 20px;
      color: var(--text);
      cursor: pointer;
      margin: 8px 0;
      font-size: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .load-more-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to right,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.1) 50%,
        rgba(255, 255, 255, 0) 100%
      );
      transform: rotate(30deg);
      animation: shimmer 3s infinite;
    }
    
    .load-more-btn:hover {
      background: var(--surface2);
      border-color: var(--primary);
      transform: scale(1.02);
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar__inner">
        <div class="brand">
          <div class="logo" title="L.G.F.L"><span class="material-symbols-rounded">forum</span></div>
          <div class="brand__name">L.G.F.L</div>
        </div>

        <nav class="nav">
          <button id="navFeed" class="btn btn--ghost"><span class="icon">dynamic_feed</span> –õ–µ–Ω—Ç–∞</button>
          <button id="navNews" class="btn btn--ghost"><span class="icon">newspaper</span> –ù–æ–≤–æ—Å—Ç–∏</button>
          <button id="navMessages" class="btn btn--ghost hidden"><span class="icon">chat</span> –°–æ–æ–±—â–µ–Ω–∏—è</button>
          <button id="navProfile" class="btn btn--ghost"><span class="icon">account_circle</span> –ü—Ä–æ—Ñ–∏–ª—å</button>
          <button id="navRTDB" class="btn btn--ghost hidden"><span class="icon">database</span> RTDB</button>
          <button id="btnLogout" class="btn btn--danger hidden"><span class="icon">logout</span> –í—ã–π—Ç–∏</button>
        </nav>
      </div>
    </header>

    <main class="content">
      <section class="leftcol">
        <!-- AUTH -->
        <div id="authCard" class="card">
          <div class="card__title"><h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2></div>

          <div class="col" style="gap:12px;">
            <div class="row" style="gap:12px; flex-wrap:wrap;">
              <div style="flex:1; min-width:220px;">
                <div class="label">–õ–æ–≥–∏–Ω</div>
                <input id="authUser" class="input" autocomplete="username" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: leaguefan">
              </div>
              <div style="flex:1; min-width:220px;">
                <div class="label">–ü–∞—Ä–æ–ª—å</div>
                <input id="authPass" class="input" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>
            </div>

            <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
              <div class="row" style="flex-wrap:wrap;">
                <button id="btnLogin" class="btn btn--primary"><span class="icon">login</span> –í–æ–π—Ç–∏</button>
                <button id="btnRegister" class="btn"><span class="icon">person_add</span> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
              </div>
              <div id="authErr" style="opacity:.92;"></div>
            </div>
          </div>
        </div>

        <!-- FEED (–æ–±—ã—á–Ω–∞—è –ª–µ–Ω—Ç–∞) -->
        <div id="feedCard" class="card hidden">
          <div class="card__title">
            <h2>–õ–µ–Ω—Ç–∞</h2>
            <div class="row" style="gap:8px; flex-wrap:wrap;">
              <button id="btnRefresh" class="btn btn--ghost" title="–û–±–Ω–æ–≤–∏—Ç—å"><span class="icon">refresh</span></button>
              <div id="feedStatus" style="opacity:.85;font-size:12px;"></div>
            </div>
          </div>

          <!-- –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Ç–æ–∫–µ–Ω–∞) -->
          <div id="adminPanel" class="admin-section hidden">
            <div class="row" style="justify-content:space-between;">
              <span><span class="icon" style="color:#bb86fc;">admin_panel_settings</span> –ê–¥–º–∏–Ω-—Ä–µ–∂–∏–º</span>
              <button id="btnExitAdmin" class="btn btn--ghost" style="padding:4px 10px;">√ó</button>
            </div>
            <div class="row" style="margin-top:8px;">
              <input type="password" id="adminTokenInput" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥–º–∏–Ω —Ç–æ–∫–µ–Ω" style="flex:1;">
              <button id="btnActivateAdmin" class="btn btn--admin"><span class="icon">verified</span> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>

          <div class="card card--flat" style="margin-bottom:12px;">
            <div class="label">–ù–æ–≤—ã–π –ø–æ—Å—Ç</div>
            <textarea id="postText" class="textarea" maxlength="1600" placeholder="–ü–∏—à–∏ —Ç–µ–∫—Å—Ç..."></textarea>
            <div class="row" style="justify-content:flex-end; margin-top:10px; flex-wrap:wrap;">
              <button id="btnPost" class="btn btn--primary"><span class="icon">send</span> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
          </div>

          <div id="feed" class="feed"></div>
        </div>

        <!-- NEWS (–Ω–æ–≤–æ—Å—Ç–∏) -->
        <div id="newsCard" class="card hidden">
          <div class="card__title">
            <h2><span class="icon" style="color:var(--news);">newspaper</span> –ù–æ–≤–æ—Å—Ç–∏</h2>
            <div class="row" style="gap:8px;">
              <button id="btnRefreshNews" class="btn btn--ghost"><span class="icon">refresh</span></button>
              <span id="newsStatus" style="opacity:.85;font-size:12px;"></span>
            </div>
          </div>

          <!-- –§–æ—Ä–º–∞ –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤) -->
          <div id="newsFormContainer" class="hidden">
            <div class="news-section">
              <div class="label">–ù–æ–≤–æ—Å—Ç—å</div>
              <textarea id="newsText" class="textarea" maxlength="1600" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏..."></textarea>
              <div class="row" style="justify-content:flex-end; margin-top:10px;">
                <button id="btnPostNews" class="btn btn--news"><span class="icon">send</span> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button>
              </div>
            </div>
          </div>

          <div id="newsFeed" class="feed"></div>
        </div>

        <!-- MESSAGES (–ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è) -->
        <div id="messagesCard" class="card hidden">
          <div class="card__title">
            <h2><span class="icon" style="color:var(--message);">chat</span> –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
            <button id="btnRefreshMessages" class="btn btn--ghost"><span class="icon">refresh</span></button>
          </div>

          <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
          <div class="chat-search">
            <div class="message-section">
              <div class="label">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
              <div class="row" style="gap:8px;">
                <input type="text" id="searchUserInput" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º..." style="flex:1;">
                <button id="btnSearchUser" class="btn btn--message"><span class="icon">search</span></button>
              </div>
              <div id="searchResults" style="margin-top:10px;"></div>
            </div>
          </div>

          <!-- –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –∏ —á–∞—Ç -->
          <div class="row" style="gap:12px; align-items:stretch;">
            <!-- –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ -->
            <div style="width:220px; flex-shrink:0;">
              <h3 style="margin:0 0 8px 0; font-size:14px;">–î–∏–∞–ª–æ–≥–∏</h3>
              <div id="dialogsList" class="feed" style="max-height:500px; overflow-y:auto;"></div>
            </div>
            
            <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
            <div style="flex:1;">
              <div id="chatContainer" class="hidden">
                <div class="chat-container">
                  <div class="chat-header">
                    <div id="chatAvatar" class="avatar-small"></div>
                    <div class="chat-header-info">
                      <div class="chat-header-name" id="chatUserName"></div>
                      <div class="chat-header-status" id="chatUserStatus">
                        <span class="status-dot"></span>
                        <span id="userStatusText"></span>
                      </div>
                    </div>
                    <div class="chat-actions">
                      <button id="btnCloseChat" class="btn btn--ghost" title="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">
                        <span class="icon">close</span>
                      </button>
                    </div>
                  </div>
                  
                  <div id="chatMessages" class="chat-messages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                  </div>
                  
                  <div class="chat-input-area">
                    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è -->
                    <div id="typingIndicator" class="typing-indicator hidden">
                      <div class="typing-dot"></div>
                      <div class="typing-dot"></div>
                      <div class="typing-dot"></div>
                      <span style="margin-left:4px; font-size:12px;">–ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                    </div>
                    
                    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
                    <div class="chat-input-wrapper">
                      <textarea id="chatMessageInput" class="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                      <button id="btnSendChatMessage" class="btn btn--message">
                        <span class="icon">send</span>
                      </button>
                    </div>
                    
                    <!-- –≠–º–æ–¥–∑–∏ (–±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø) -->
                    <div class="chat-emoji-picker">
                      <button class="emoji-btn" data-emoji="üëç">üëç</button>
                      <button class="emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                      <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
                      <button class="emoji-btn" data-emoji="üòÆ">üòÆ</button>
                      <button class="emoji-btn" data-emoji="üò¢">üò¢</button>
                      <button class="emoji-btn" data-emoji="üëã">üëã</button>
                      <button class="emoji-btn" data-emoji="üî•">üî•</button>
                      <button class="emoji-btn" data-emoji="‚úÖ">‚úÖ</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- –ó–∞–≥–ª—É—à–∫–∞, –∫–æ–≥–¥–∞ —á–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω -->
              <div id="noChatSelected" class="post" style="text-align:center; padding:40px;">
                <span class="icon" style="font-size:48px; opacity:0.5;">chat</span>
                <p style="margin-top:16px; opacity:0.7;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
              </div>
            </div>
          </div>
        </div>

        <!-- PROFILE -->
        <div id="profileCard" class="card hidden">
          <div class="card__title"><h2>–ü—Ä–æ—Ñ–∏–ª—å</h2></div>

          <div class="col" style="gap:12px;">
            <div class="card card--flat">
              <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ –∫–∞–∫ –≤ Discord -->
              <div class="profile-header">
                <div class="avatar-container" id="avatarContainer">
                  <div id="avatarPreview" class="avatar-placeholder">?</div>
                  <div class="avatar-overlay">
                    <span class="icon">photo_camera</span>
                  </div>
                  <input type="file" id="avatarUpload" class="avatar-upload" accept="image/*" />
                </div>
                <div style="flex:1;">
                  <div class="label">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</div>
                  <div class="row" style="gap:8px; margin-bottom:12px;">
                    <input id="displayName" class="input" placeholder="–ö–∞–∫ –≤–∞—Å –Ω–∞–∑—ã–≤–∞—Ç—å" style="flex:1;">
                    <button id="btnSaveDisplayName" class="btn btn--primary"><span class="icon">save</span></button>
                  </div>
                  
                  <div class="label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–æ–≥–∏–Ω)</div>
                  <div class="row" style="gap:8px;">
                    <input id="username" class="input" placeholder="username" style="flex:1;" disabled>
                    <button id="btnChangeUsername" class="btn btn--ghost"><span class="icon">edit</span></button>
                  </div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
                <div class="row" style="gap:14px; flex-wrap:wrap;">
                  <span class="badge"><span class="icon">article</span> –ü–æ—Å—Ç–æ–≤: <b id="pCount">0</b></span>
                  <span id="adminBadgeProfile" class="badge badge--admin hidden"><span class="icon">verified</span> –ê–¥–º–∏–Ω</span>
                  <span id="leaguefunBadgeProfile" class="badge badge--leaguefun hidden"><span class="icon">star</span> LEGEND</span>
                </div>
                <button id="btnMyPosts" class="btn btn--ghost"><span class="icon">filter_alt</span> –ú–æ–∏ –ø–æ—Å—Ç—ã</button>
              </div>
            </div>

            <div>
              <div class="row" style="justify-content:space-between; margin-bottom:10px;">
                <div style="font-size:12px;opacity:.85;">–ú–æ–∏ –ø–æ—Å—Ç—ã</div>
                <button id="btnMyPostsClear" class="btn btn--ghost hidden"><span class="icon">close</span> –°–∫—Ä—ã—Ç—å</button>
              </div>
              <div id="myPosts" class="feed hidden"></div>
            </div>
          </div>
        </div>

        <!-- RTDB VIEWER (—Ç–æ–ª—å–∫–æ –¥–ª—è f1leaguebot) -->
        <div id="rtdbCard" class="card hidden">
          <div class="card__title">
            <h2><span class="icon" style="color:var(--primary);">database</span> RTDB –ü—Ä–æ—Å–º–æ—Ç—Ä</h2>
            <button id="btnRefreshRTDB" class="btn btn--ghost"><span class="icon">refresh</span></button>
          </div>
          
          <div class="col" style="gap:12px;">
            <div class="row" style="flex-wrap:wrap;">
              <select id="rtdbPath" class="input" style="flex:1;">
                <option value="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (users)</option>
                <option value="posts">–ü–æ—Å—Ç—ã (posts)</option>
                <option value="news">–ù–æ–≤–æ—Å—Ç–∏ (news)</option>
                <option value="messages">–°–æ–æ–±—â–µ–Ω–∏—è (messages)</option>
                <option value="messages_archive">–ê—Ä—Ö–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π</option>
                <option value="root" selected>–í—Å—è –±–∞–∑–∞ (root)</option>
              </select>
              <button id="btnLoadRTDB" class="btn btn--primary"><span class="icon">visibility</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            
            <div class="admin-section" style="margin-bottom:0;">
              <span class="badge badge--admin"><span class="icon">admin_panel_settings</span> –¢–æ–ª—å–∫–æ –¥–ª—è f1leaguebot</span>
              <span class="badge badge--bot" style="margin-left:8px;"><span class="icon">smart_toy</span> –ë–æ—Ç-–∞–∫–∫–∞—É–Ω—Ç</span>
            </div>

            <div id="rtdbContent" class="json-view">
              –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
            </div>
          </div>
        </div>
      </section>

      <aside class="rightcol">
        <div class="card">
          <div class="card__title"><h2>–°—Ç–∞—Ç—É—Å</h2></div>
          <div class="col" style="gap:10px;">
            <div class="row" style="gap:8px;">
              <div id="userAvatarSmall" class="avatar-small"></div>
              <span id="statusAuth" class="badge"><span class="icon">key</span> –ì–æ—Å—Ç—å</span>
            </div>
            <span id="statusDb" class="badge"><span class="icon">database</span> RTDB: ‚Äî</span>
            <span id="adminStatus" class="badge hidden"><span class="icon">admin_panel_settings</span> –ê–¥–º–∏–Ω</span>
            <span id="botStatus" class="badge badge--bot hidden"><span class="icon">smart_toy</span> –ë–æ—Ç</span>
            <span id="leaguefunStatus" class="badge badge--leaguefun hidden"><span class="icon">star</span> LEGEND</span>
            <span id="unreadMessages" class="badge badge--message hidden"><span class="icon">chat</span> –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</span>
            <span id="archivedMessages" class="badge badge--time hidden"><span class="icon">archive</span> –ê—Ä—Ö–∏–≤</span>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="card__title"><h2>–û —Ä–∞–∑–¥–µ–ª–∞—Ö</h2></div>
          <div class="col" style="gap:8px;">
            <div><span class="badge" style="background:var(--surface2);">üì∞ –ù–æ–≤–æ—Å—Ç–∏</span> ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤</div>
            <div><span class="badge" style="background:var(--surface2);">üí¨ –õ–µ–Ω—Ç–∞</span> ‚Äî –¥–ª—è –≤—Å–µ—Ö</div>
            <div><span class="badge" style="background:var(--surface2);">üí≠ –°–æ–æ–±—â–µ–Ω–∏—è</span> ‚Äî –ª–∏—á–Ω—ã–µ</div>
          </div>
        </div>
      </aside>
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite">
      <span class="icon" id="toastIcon">info</span>
      <div id="toastMsg"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getDatabase, ref, get, set, update, push, onValue, remove, query, orderByChild, equalTo, onDisconnect, limitToLast
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
    import { 
      getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject 
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

    // ====== –ù–ê–°–¢–†–û–ô–ö–ò ======
    const ADMIN_KEY = "F1leaguebot";
    const BOT_USERNAME = "f1leaguebot";
    const LEGEND_USERNAME = "leaguefun";
    const ENCRYPTION_KEY = "LGFSecretKey2024";
    const MAX_AVATAR_SIZE = 5 * 1024 * 1024; // 5MB –∫–∞–∫ –≤ Discord
    const MESSAGES_PER_PAGE = 50; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const ARCHIVE_DAYS = 30; // –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
    
    const firebaseConfig = {
      apiKey: "AIzaSyBsWh1hoWrrlMROmv9AiVWWNTjMn64bJPQ",
      authDomain: "f1leaguesite.firebaseapp.com",
      projectId: "f1leaguesite",
      storageBucket: "f1leaguesite.firebasestorage.app",
      messagingSenderId: "600195548760",
      appId: "1:600195548760:web:8c193f3add9a46c2192c2d",
      measurementId: "G-60N6QR300J",
      databaseURL: "https://f1leaguesite-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // ====== DOM ======
    const $ = (id) => document.getElementById(id);

    const authCard = $("authCard");
    const feedCard = $("feedCard");
    const newsCard = $("newsCard");
    const messagesCard = $("messagesCard");
    const profileCard = $("profileCard");
    const rtdbCard = $("rtdbCard");

    const navFeed = $("navFeed");
    const navNews = $("navNews");
    const navMessages = $("navMessages");
    const navProfile = $("navProfile");
    const btnLogout = $("btnLogout");
    const navRTDB = $("navRTDB");

    const statusAuth = $("statusAuth");
    const statusDb = $("statusDb");
    const feedStatus = $("feedStatus");
    const newsStatus = $("newsStatus");
    const adminStatus = $("adminStatus");
    const botStatus = $("botStatus");
    const leaguefunStatus = $("leaguefunStatus");
    const unreadMessages = $("unreadMessages");
    const archivedMessages = $("archivedMessages");
    const adminBadgeProfile = $("adminBadgeProfile");
    const leaguefunBadgeProfile = $("leaguefunBadgeProfile");
    const userAvatarSmall = $("userAvatarSmall");

    const adminPanel = $("adminPanel");
    const adminTokenInput = $("adminTokenInput");
    const btnActivateAdmin = $("btnActivateAdmin");
    const btnExitAdmin = $("btnExitAdmin");

    const newsFormContainer = $("newsFormContainer");
    const newsText = $("newsText");
    const btnPostNews = $("btnPostNews");
    const btnRefreshNews = $("btnRefreshNews");
    const newsFeed = $("newsFeed");

    // –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
    const avatarContainer = $("avatarContainer");
    const avatarUpload = $("avatarUpload");
    const avatarPreview = $("avatarPreview");
    const displayNameInput = $("displayName");
    const usernameInput = $("username");
    const btnSaveDisplayName = $("btnSaveDisplayName");
    const btnChangeUsername = $("btnChangeUsername");
    const pCount = $("pCount");

    // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
    const btnRefreshMessages = $("btnRefreshMessages");
    const searchUserInput = $("searchUserInput");
    const btnSearchUser = $("btnSearchUser");
    const searchResults = $("searchResults");
    const dialogsList = $("dialogsList");
    const chatContainer = $("chatContainer");
    const noChatSelected = $("noChatSelected");
    const chatAvatar = $("chatAvatar");
    const chatUserName = $("chatUserName");
    const chatUserStatus = $("chatUserStatus");
    const userStatusText = $("userStatusText");
    const chatMessages = $("chatMessages");
    const chatMessageInput = $("chatMessageInput");
    const btnSendChatMessage = $("btnSendChatMessage");
    const btnCloseChat = $("btnCloseChat");
    const typingIndicator = $("typingIndicator");

    const rtdbPath = $("rtdbPath");
    const btnLoadRTDB = $("btnLoadRTDB");
    const btnRefreshRTDB = $("btnRefreshRTDB");
    const rtdbContent = $("rtdbContent");

    const toastEl = $("toast");
    const toastIcon = $("toastIcon");
    const toastMsg = $("toastMsg");
    let toastTimer = null;

    // ====== –°–û–°–¢–û–Ø–ù–ò–ï ======
    let sessionUser = null;
    let isAdminMode = false;
    let currentChat = null;
    let usersCache = {};
    let typingTimeout = null;
    let messagesListeners = new Map(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
    let currentMessagesPage = 1;
    let hasMoreMessages = true;
    let messagesEndRef = null;
    const LS_KEY = "lgfl_session_v1";

    function toast(message, icon="info", ms=2400){
      toastIcon.textContent = icon;
      toastMsg.innerHTML = message;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove("show"), ms);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showOnly(which){
      authCard.classList.toggle("hidden", which !== "auth");
      feedCard.classList.toggle("hidden", which !== "feed");
      newsCard.classList.toggle("hidden", which !== "news");
      messagesCard.classList.toggle("hidden", which !== "messages");
      profileCard.classList.toggle("hidden", which !== "profile");
      rtdbCard.classList.toggle("hidden", which !== "rtdb");
    }

    function routeTo(hash){ location.hash = hash; }
    function currentRoute(){
      const h = (location.hash || "#feed").toLowerCase();
      if(h.includes("profile")) return "profile";
      if(h.includes("news")) return "news";
      if(h.includes("messages")) return "messages";
      if(h.includes("rtdb")) return "rtdb";
      return "feed";
    }

    // ====== –°–ï–°–°–ò–Ø ======
    function saveSession(u){
      localStorage.setItem(LS_KEY, JSON.stringify(u));
      sessionUser = u;
      refreshUI();
    }
    function clearSession(){
      localStorage.removeItem(LS_KEY);
      sessionUser = null;
      isAdminMode = false;
      refreshUI();
    }
    function loadSession(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        const u = JSON.parse(raw);
        if(u && u.username && u.id) return u;
      }catch(_){}
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∏
    function isBotUser(username) {
      return username && username.toLowerCase() === BOT_USERNAME;
    }
    function isLegendUser(username) {
      return username && username.toLowerCase() === LEGEND_USERNAME;
    }
    function canWriteNews() {
      if(!sessionUser) return false;
      return isBotUser(sessionUser.username) || isAdminMode;
    }
    function canDeleteNews() {
      if(!sessionUser) return false;
      return isBotUser(sessionUser.username);
    }

    // ====== –ö–†–ò–ü–¢–û–ì–†–ê–§–ò–Ø SHA-256 ======
    async function sha256Hash(text) {
      if (!text) return text;
      const encoder = new TextEncoder();
      const data = encoder.encode(text + ENCRYPTION_KEY);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    // ====== –ê–í–ê–¢–ê–†–ö–ò ======
    async function uploadAvatar(file) {
      if (!sessionUser) return null;
      
      if (file.size > MAX_AVATAR_SIZE) {
        toast(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5MB`, "error");
        return null;
      }
      
      if (!file.type.startsWith('image/')) {
        toast("–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", "error");
        return null;
      }
      
      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `avatars/${sessionUser.id}_${Date.now()}.${fileExt}`;
        const avatarRef = storageRef(storage, fileName);
        
        await uploadBytes(avatarRef, file);
        const downloadUrl = await getDownloadURL(avatarRef);
        
        const userData = await get(userRef(sessionUser.username));
        const currentData = userData.val() || {};
        
        if (currentData.avatar) {
          try {
            const oldAvatarRef = storageRef(storage, currentData.avatar);
            await deleteObject(oldAvatarRef);
          } catch (e) {
            console.log("–°—Ç–∞—Ä–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
          }
        }
        
        await update(userRef(sessionUser.username), {
          avatar: downloadUrl,
          avatarPath: fileName
        });
        
        return downloadUrl;
      } catch (e) {
        toast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + e.message, "error");
        return null;
      }
    }

    avatarContainer.addEventListener("click", () => {
      avatarUpload.click();
    });

    avatarUpload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        avatarPreview.innerHTML = `<img src="${e.target.result}" class="avatar-image" />`;
      };
      reader.readAsDataURL(file);
      
      const url = await uploadAvatar(file);
      if (url) {
        toast("–ê–≤–∞—Ç–∞—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!", "check_circle");
        updateAvatarDisplay(url);
      }
    });

    function updateAvatarDisplay(url) {
      if (url) {
        avatarPreview.innerHTML = `<img src="${url}" class="avatar-image" />`;
        userAvatarSmall.innerHTML = `<img src="${url}" class="avatar-image" />`;
      } else {
        const initial = sessionUser?.displayName?.[0] || sessionUser?.username?.[0] || "?";
        avatarPreview.innerHTML = `<div class="avatar-placeholder">${initial.toUpperCase()}</div>`;
        userAvatarSmall.innerHTML = `<div class="avatar-small"><div class="placeholder">${initial.toUpperCase()}</div></div>`;
      }
    }

    // ====== –°–ú–ï–ù–ê –ò–ú–ï–ù–ò ======
    btnSaveDisplayName.addEventListener("click", async () => {
      if (!sessionUser) return;
      
      const newName = displayNameInput.value.trim();
      if (!newName) return toast("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º", "warning");
      if (newName.length > 32) return toast("–ò–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å. 32 —Å–∏–º–≤–æ–ª–∞)", "warning");
      
      try {
        const encryptedName = await sha256Hash(newName);
        
        await update(userRef(sessionUser.username), {
          displayName: encryptedName,
          _original: {
            ...(await (await get(userRef(sessionUser.username))).val()._original || {}),
            displayName: newName
          }
        });
        
        sessionUser.displayName = newName;
        saveSession(sessionUser);
        toast("–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ!", "check_circle");
      } catch (e) {
        toast("–û—à–∏–±–∫–∞: " + e.message, "error");
      }
    });

    btnChangeUsername.addEventListener("click", async () => {
      if (!sessionUser) return;
      
      const newUsername = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ª–æ–≥–∏–Ω (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _ –∏ .):", sessionUser.username);
      if (!newUsername) return;
      
      const normalized = normalizeUsername(newUsername);
      if (!normalized) return toast("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ª–æ–≥–∏–Ω", "warning");
      if (normalized === sessionUser.username) return toast("–≠—Ç–æ –≤–∞—à —Ç–µ–∫—É—â–∏–π –ª–æ–≥–∏–Ω", "info");
      
      try {
        const snap = await get(userRef(normalized));
        if (snap.exists()) {
          return toast("–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç", "error");
        }
        
        const currentData = (await get(userRef(sessionUser.username))).val();
        
        const newData = {
          ...currentData,
          username: await sha256Hash(normalized),
          _original: {
            ...currentData._original,
            username: normalized
          }
        };
        
        await set(userRef(normalized), newData);
        await remove(userRef(sessionUser.username));
        
        sessionUser.username = normalized;
        saveSession(sessionUser);
        
        toast("–õ–æ–≥–∏–Ω –∏–∑–º–µ–Ω—ë–Ω! –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", "check_circle");
      } catch (e) {
        toast("–û—à–∏–±–∫–∞: " + e.message, "error");
      }
    });

    // ====== RTDB PATHS ======
    const usersRef = () => ref(db, "users");
    const userRef = (username) => ref(db, `users/${username}`);
    const postsRef = () => ref(db, "posts");
    const newsRef = () => ref(db, "news");
    const messagesRef = () => ref(db, "messages");
    const messagesArchiveRef = () => ref(db, "messages_archive");
    const userStatusRef = (userId) => ref(db, `status/${userId}`);

    // ====== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–ï–†–ï–ü–ò–°–û–ö ======

    // –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    async function archiveOldMessages() {
      const thirtyDaysAgo = Date.now() - (ARCHIVE_DAYS * 24 * 60 * 60 * 1000);
      
      const messagesSnap = await get(messagesRef());
      if (!messagesSnap.exists()) return;
      
      const messages = messagesSnap.val();
      
      for (const [convId, convMessages] of Object.entries(messages)) {
        const archiveConv = {};
        const keepConv = {};
        
        for (const [msgId, msg] of Object.entries(convMessages)) {
          if (msg.createdAt < thirtyDaysAgo) {
            // –°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π - –≤ –∞—Ä—Ö–∏–≤
            if (!archiveConv[msgId]) {
              archiveConv[msgId] = msg;
            }
          } else {
            // –°–æ–æ–±—â–µ–Ω–∏–µ –º–ª–∞–¥—à–µ 30 –¥–Ω–µ–π - –æ—Å—Ç–∞–≤–ª—è–µ–º
            if (!keepConv[msgId]) {
              keepConv[msgId] = msg;
            }
          }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ö–∏–≤
        if (Object.keys(archiveConv).length > 0) {
          await set(ref(db, `messages_archive/${convId}`), archiveConv);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        await set(ref(db, `messages/${convId}`), keepConv);
      }
      
      console.log("–ê—Ä—Ö–∏–≤–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∞—Ä—Ö–∏–≤–∞
    async function loadMessagesWithArchive(convId, page = 1) {
      const messagesPerPage = MESSAGES_PER_PAGE;
      const startIndex = (page - 1) * messagesPerPage;
      const endIndex = startIndex + messagesPerPage - 1;
      
      let allMessages = [];
      let hasMore = false;
      
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ç–µ–∫—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      const currentSnap = await get(ref(db, `messages/${convId}`));
      if (currentSnap.exists()) {
        const currentMessages = Object.entries(currentSnap.val())
          .map(([id, msg]) => ({ id, ...msg }))
          .sort((a, b) => b.createdAt - a.createdAt);
        
        allMessages = [...currentMessages];
      }
      
      // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –∞—Ä—Ö–∏–≤–∞
      if (allMessages.length < endIndex + 1) {
        const archiveSnap = await get(ref(db, `messages_archive/${convId}`));
        if (archiveSnap.exists()) {
          const archiveMessages = Object.entries(archiveSnap.val())
            .map(([id, msg]) => ({ id, ...msg, archived: true }))
            .sort((a, b) => b.createdAt - a.createdAt);
          
          allMessages = [...allMessages, ...archiveMessages];
        }
      }
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –¥–∞—Ç–µ
      allMessages.sort((a, b) => b.createdAt - a.createdAt);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â—ë —Å–æ–æ–±—â–µ–Ω–∏—è
      hasMore = allMessages.length > endIndex + 1;
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
      const pageMessages = allMessages.slice(startIndex, endIndex + 1).reverse();
      
      return {
        messages: pageMessages,
        hasMore,
        total: allMessages.length
      };
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≤—Å–µ—Ö –º–µ—Å—Ç
    async function deleteMessagePermanently(convId, messageId) {
      try {
        // –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –∏–∑ —Ç–µ–∫—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        await remove(ref(db, `messages/${convId}/${messageId}`));
        // –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞
        await remove(ref(db, `messages_archive/${convId}/${messageId}`));
        return true;
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
        return false;
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
    function cleanupMessagesListeners() {
      messagesListeners.forEach((unsub, convId) => {
        if (unsub) unsub();
      });
      messagesListeners.clear();
    }

    // ====== –ó–ê–ì–†–£–ó–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ======
    async function loadUsersCache() {
      try {
        const snap = await get(usersRef());
        if (snap.exists()) {
          const users = snap.val();
          for (const [username, data] of Object.entries(users)) {
            // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID –∏–∑ _original –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π
            const userId = data._original?.id || data.id;
            usersCache[username] = {
              id: userId,
              displayName: data._original?.displayName || username,
              avatar: data.avatar || null
            };
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username} —Å ID: ${userId}`);
          }
        }
        console.log("–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫—ç—à–µ:", Object.keys(usersCache).length);
      } catch(e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", e);
      }
    }

    // ====== –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ======
    btnSearchUser.addEventListener("click", async () => {
      const query = searchUserInput.value.trim().toLowerCase();
      if (!query || !sessionUser) return;

      searchResults.innerHTML = "";
      const results = [];

      for (const [username, data] of Object.entries(usersCache)) {
        if (username.includes(query) && username !== sessionUser.username) {
          results.push({ username, displayName: data.displayName, avatar: data.avatar });
        }
      }

      if (results.length === 0) {
        searchResults.innerHTML = '<div class="post">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
      }

      for (const user of results) {
        const el = document.createElement("div");
        el.className = "user-search-result";
        el.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div class="row" style="gap:8px;">
              <div class="avatar-small">
                ${user.avatar ? `<img src="${user.avatar}" class="avatar-image" />` : `<div class="placeholder">${user.displayName[0]}</div>`}
              </div>
              <span>${escapeHtml(user.displayName)} (@${escapeHtml(user.username)})</span>
            </div>
            <button class="btn btn--message btn-start-chat" data-username="${user.username}">–ù–∞–ø–∏—Å–∞—Ç—å</button>
          </div>
        `;
        
        el.querySelector('.btn-start-chat').addEventListener('click', () => {
          const userData = usersCache[user.username];
          if (userData) {
            openChat(user.username, userData.id, userData.displayName, userData.avatar);
          }
        });
        
        searchResults.appendChild(el);
      }
    });

    // ====== –ß–ê–¢ ======
    function openChat(username, userId, displayName, avatar) {
      if (!sessionUser) return;
      
      console.log("–û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ —Å:", username, userId);
      currentChat = { userId, username, displayName, avatar };
      chatUserName.innerHTML = `${escapeHtml(displayName)} <span style="opacity:0.7;">(@${escapeHtml(username)})</span>`;
      currentMessagesPage = 1;
      hasMoreMessages = true;
      
      if (avatar) {
        chatAvatar.innerHTML = `<img src="${avatar}" class="avatar-image" />`;
      } else {
        chatAvatar.innerHTML = `<div class="placeholder">${displayName[0]}</div>`;
      }
      
      chatContainer.classList.remove("hidden");
      noChatSelected.classList.add("hidden");
      
      loadMessagesWithPagination(userId, 1);
      setupStatusListener(userId);
    }

    function closeChat() {
      currentChat = null;
      chatContainer.classList.add("hidden");
      noChatSelected.classList.remove("hidden");
      chatMessages.innerHTML = "";
      cleanupMessagesListeners();
    }

    btnCloseChat.addEventListener("click", closeChat);

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
    async function loadMessagesWithPagination(otherUserId, page = 1) {
      if (!sessionUser || !otherUserId) return;

      const convId = [sessionUser.id, otherUserId].sort().join('_');
      console.log("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:", convId);
      
      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
      if (messagesListeners.has(convId)) {
        messagesListeners.get(convId)();
      }

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      const messagesQuery = query(ref(db, `messages/${convId}`), orderByChild('createdAt'), limitToLast(50));
      const unsub = onValue(messagesQuery, async (snap) => {
        console.log("–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã");
        // –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        if (page === 1) {
          const result = await loadMessagesWithArchive(convId, 1);
          displayMessages(result.messages, 1, result.hasMore, result.total, convId);
        }
      });

      messagesListeners.set(convId, unsub);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—É—â–∏—Ö –∏ –∞—Ä—Ö–∏–≤–∞
      const result = await loadMessagesWithArchive(convId, page);
      displayMessages(result.messages, page, result.hasMore, result.total, convId);
    }

    function displayMessages(messages, page, hasMore, total, convId) {
      chatMessages.innerHTML = "";
      
      if (messages.length === 0) {
        chatMessages.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!</div>';
        return;
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë", –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
      if (hasMore && page === 1) {
        const loadMoreBtn = document.createElement("button");
        loadMoreBtn.className = "load-more-btn";
        loadMoreBtn.innerHTML = `<span class="icon">expand_more</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (${total - MESSAGES_PER_PAGE} –µ—â–µ)`;
        loadMoreBtn.addEventListener("click", () => {
          currentMessagesPage++;
          loadMessagesWithPagination(currentChat.userId, currentMessagesPage);
        });
        chatMessages.appendChild(loadMoreBtn);
      }
      
      let lastDate = null;
      
      for (const msg of messages) {
        const msgDate = new Date(msg.createdAt).toLocaleDateString();
        if (msgDate !== lastDate) {
          const dateDivider = document.createElement("div");
          dateDivider.style.textAlign = "center";
          dateDivider.style.margin = "16px 0 8px";
          dateDivider.style.opacity = "0.5";
          dateDivider.style.fontSize = "11px";
          dateDivider.innerHTML = msgDate + (msg.archived ? ' <span class="archive-badge">–∞—Ä—Ö–∏–≤</span>' : '');
          chatMessages.appendChild(dateDivider);
          lastDate = msgDate;
        }
        
        const isSent = msg.from === sessionUser.id;
        const wrapper = document.createElement("div");
        wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
        
        const bubble = document.createElement("div");
        bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
        
        const time = new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const text = msg._original?.text || msg.text || "";
        
        let statusHtml = '';
        if (isSent) {
          statusHtml = `
            <div class="message-status ${msg.read ? 'read' : ''}">
              <span class="icon">${msg.read ? 'done_all' : 'done'}</span>
              ${msg.read ? '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ' : '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'}
            </div>
          `;
        }
        
        bubble.innerHTML = `
          <div>${escapeHtml(text)}</div>
          <div class="message-time">${time}</div>
          ${statusHtml}
        `;
        
        wrapper.appendChild(bubble);
        chatMessages.appendChild(wrapper);
        
        if (!isSent && !msg.read) {
          update(ref(db, `messages/${convId}/${msg.id}`), { read: true });
        }
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë" –≤ –Ω–∞—á–∞–ª–æ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
      if (hasMore && page > 1) {
        const loadMoreBtn = document.createElement("button");
        loadMoreBtn.className = "load-more-btn";
        loadMoreBtn.innerHTML = `<span class="icon">expand_more</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë`;
        loadMoreBtn.addEventListener("click", () => {
          currentMessagesPage++;
          loadMessagesWithPagination(currentChat.userId, currentMessagesPage);
        });
        chatMessages.insertBefore(loadMoreBtn, chatMessages.firstChild);
      }
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function setupStatusListener(userId) {
      onValue(userStatusRef(userId), (snap) => {
        const status = snap.val();
        const isOnline = status && status.online;
        
        if (isOnline) {
          userStatusText.innerHTML = '<span class="status-online">‚óè –û–Ω–ª–∞–π–Ω</span>';
        } else {
          const lastSeen = status?.lastSeen ? new Date(status.lastSeen).toLocaleString() : '–Ω–∏–∫–æ–≥–¥–∞';
          userStatusText.innerHTML = `<span class="status-offline">‚óè –û—Ñ—Ñ–ª–∞–π–Ω (–±—ã–ª(–∞): ${lastSeen})</span>`;
        }
      });
    }

    function updateUserStatus(online) {
      if (!sessionUser) return;
      
      const statusRef = userStatusRef(sessionUser.id);
      if (online) {
        set(statusRef, {
          online: true,
          lastSeen: Date.now()
        });
        onDisconnect(statusRef).set({
          online: false,
          lastSeen: Date.now()
        });
      } else {
        set(statusRef, {
          online: false,
          lastSeen: Date.now()
        });
      }
    }

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
    function setupTypingListener(chatId) {
      const typingRef = ref(db, `typing/${chatId}`);
      onValue(typingRef, (snap) => {
        const data = snap.val();
        if (data && data.userId === currentChat?.userId && data.typing) {
          typingIndicator.classList.remove("hidden");
          setTimeout(() => typingIndicator.classList.add("hidden"), 3000);
        }
      });
    }

    function sendTypingIndicator() {
      if (!sessionUser || !currentChat) return;
      
      const chatId = [sessionUser.id, currentChat.userId].sort().join('_');
      const typingRef = ref(db, `typing/${chatId}`);
      
      set(typingRef, {
        userId: sessionUser.id,
        typing: true,
        timestamp: Date.now()
      });
      
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        set(typingRef, {
          userId: sessionUser.id,
          typing: false,
          timestamp: Date.now()
        });
      }, 2000);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    btnSendChatMessage.addEventListener("click", async () => {
      if (!sessionUser || !currentChat) return;
      
      const text = chatMessageInput.value.trim();
      if (!text) return;

      const convId = [sessionUser.id, currentChat.userId].sort().join('_');
      console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –¥–∏–∞–ª–æ–≥:", convId);
      
      try {
        const message = {
          from: sessionUser.id,
          to: currentChat.userId,
          text: await sha256Hash(text),
          createdAt: Date.now(),
          read: false,
          _original: { text }
        };
        
        await push(ref(db, `messages/${convId}`), message);
        chatMessageInput.value = "";
        chatMessageInput.style.height = "auto";
        
        clearTimeout(typingTimeout);
        const typingRef = ref(db, `typing/${convId}`);
        set(typingRef, {
          userId: sessionUser.id,
          typing: false,
          timestamp: Date.now()
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
        archiveOldMessages();
      } catch(e) {
        toast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message, "error");
      }
    });

    chatMessageInput.addEventListener("input", () => {
      chatMessageInput.style.height = "auto";
      chatMessageInput.style.height = (chatMessageInput.scrollHeight) + "px";
      sendTypingIndicator();
    });

    chatMessageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        btnSendChatMessage.click();
      }
    });

    document.querySelectorAll('.emoji-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        chatMessageInput.value += btn.dataset.emoji;
        chatMessageInput.dispatchEvent(new Event('input'));
      });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤
    function loadDialogs() {
      if (!sessionUser) {
        console.log("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏–∏");
        return;
      }

      console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", sessionUser.username, sessionUser.id);
      dialogsList.innerHTML = "<div class='post'>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤...</div>";

      // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
      onValue(messagesRef(), async (snap) => {
        console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏–π");
        const val = snap.val() || {};
        const dialogs = new Map();
        let unreadCount = 0;

        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –¥–∏–∞–ª–æ–≥–∞–º
        for (const [convId, messages] of Object.entries(val)) {
          const [id1, id2] = convId.split('_');
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ
          if (id1 === sessionUser.id || id2 === sessionUser.id) {
            const otherId = id1 === sessionUser.id ? id2 : id1;
            console.log("–ù–∞–π–¥–µ–Ω –¥–∏–∞–ª–æ–≥ —Å ID:", otherId);
            
            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID –≤ –∫—ç—à–µ
            let foundUser = null;
            for (const [username, data] of Object.entries(usersCache)) {
              if (data.id === otherId) {
                foundUser = { username, ...data };
                break;
              }
            }
            
            if (foundUser) {
              // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
              const messagesArray = Object.values(messages);
              const sortedMessages = messagesArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
              const lastMsg = sortedMessages[0];
              
              // –°—á–∏—Ç–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              let unreadInDialog = 0;
              for (const msg of messagesArray) {
                if (msg.to === sessionUser.id && !msg.read) {
                  unreadInDialog++;
                  unreadCount++;
                }
              }
              
              dialogs.set(foundUser.username, {
                id: foundUser.id,
                displayName: foundUser.displayName,
                avatar: foundUser.avatar,
                lastMsg: lastMsg?._original?.text || '...',
                lastTime: lastMsg?.createdAt,
                unread: unreadInDialog
              });
              
              console.log("–î–æ–±–∞–≤–ª–µ–Ω –¥–∏–∞–ª–æ–≥ —Å:", foundUser.username);
            }
          }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤
        const archiveSnap = await get(messagesArchiveRef());
        if (archiveSnap.exists()) {
          const archiveVal = archiveSnap.val();
          for (const [convId, messages] of Object.entries(archiveVal)) {
            const [id1, id2] = convId.split('_');
            if (id1 === sessionUser.id || id2 === sessionUser.id) {
              const otherId = id1 === sessionUser.id ? id2 : id1;
              
              // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID –≤ –∫—ç—à–µ
              for (const [username, data] of Object.entries(usersCache)) {
                if (data.id === otherId && !dialogs.has(username)) {
                  // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥ –∏–∑ –∞—Ä—Ö–∏–≤–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ —Ç–µ–∫—É—â–∏—Ö
                  const messagesArray = Object.values(messages);
                  const sortedMessages = messagesArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                  const lastMsg = sortedMessages[0];
                  
                  dialogs.set(username, {
                    id: data.id,
                    displayName: data.displayName,
                    avatar: data.avatar,
                    lastMsg: lastMsg?._original?.text || '...',
                    lastTime: lastMsg?.createdAt,
                    unread: 0,
                    archived: true
                  });
                  console.log("–î–æ–±–∞–≤–ª–µ–Ω –∞—Ä—Ö–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å:", username);
                  break;
                }
              }
            }
          }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        if (unreadCount > 0) {
          unreadMessages.classList.remove("hidden");
          unreadMessages.innerHTML = `<span class="icon">chat</span> ${unreadCount} –Ω–æ–≤—ã—Ö`;
        } else {
          unreadMessages.classList.add("hidden");
        }

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
        if (dialogs.size === 0) {
          dialogsList.innerHTML = '<div class="post">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>';
          return;
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        const sortedDialogs = Array.from(dialogs.entries())
          .sort((a, b) => (b[1].lastTime || 0) - (a[1].lastTime || 0));

        dialogsList.innerHTML = "";
        let hasArchived = false;
        
        for (const [username, data] of sortedDialogs) {
          if (data.archived) hasArchived = true;
          
          const el = document.createElement("div");
          el.className = `post post--message dialog-item ${currentChat?.username === username ? 'active' : ''}`;
          
          const lastTime = data.lastTime ? formatDateTime(data.lastTime) : '';
          const lastMsgPreview = data.lastMsg ? escapeHtml(data.lastMsg.substring(0, 30)) + (data.lastMsg.length > 30 ? '...' : '') : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
          
          el.innerHTML = `
            <div class="row" style="gap:8px; align-items:center;">
              <div class="avatar-small">
                ${data.avatar ? `<img src="${data.avatar}" class="avatar-image" />` : `<div class="placeholder">${data.displayName[0]}</div>`}
              </div>
              <div style="flex:1;">
                <div style="display:flex; align-items:center; gap:4px; margin-bottom:4px;">
                  <span class="badge badge--message"><span class="icon">person</span> ${escapeHtml(data.displayName)}</span>
                  <span style="opacity:0.7; font-size:11px;">@${escapeHtml(username)}</span>
                  ${data.unread ? `<span class="unread-badge">${data.unread}</span>` : ''}
                  ${data.archived ? `<span class="archive-badge">–∞—Ä—Ö–∏–≤</span>` : ''}
                </div>
                <div style="font-size:12px; opacity:0.7; display:flex; align-items:center; gap:4px;">
                  <span class="icon" style="font-size:14px;">chat</span>
                  <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:120px;">${lastMsgPreview}</span>
                  <span style="margin-left:auto; font-size:10px;">${lastTime}</span>
                </div>
              </div>
            </div>
          `;
          
          el.addEventListener('click', () => {
            openChat(username, data.id, data.displayName, data.avatar);
          });
          
          dialogsList.appendChild(el);
        }

        if (hasArchived) {
          archivedMessages.classList.remove("hidden");
          archivedMessages.innerHTML = '<span class="icon">archive</span> –ï—Å—Ç—å –∞—Ä—Ö–∏–≤';
        } else {
          archivedMessages.classList.add("hidden");
        }
        
        console.log("–í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤:", dialogs.size);
      });
    }

    // ====== RTDB –ü–†–û–°–ú–û–¢–† ======
    async function loadRTDBData(path) {
      if(!sessionUser || !isBotUser(sessionUser.username)) {
        toast("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", "error");
        return;
      }

      try {
        let dataRef;
        switch(path) {
          case 'users':
            dataRef = usersRef();
            break;
          case 'posts':
            dataRef = postsRef();
            break;
          case 'news':
            dataRef = newsRef();
            break;
          case 'messages':
            dataRef = messagesRef();
            break;
          case 'messages_archive':
            dataRef = messagesArchiveRef();
            break;
          case 'root':
          default:
            dataRef = ref(db, '/');
        }

        const snap = await get(dataRef);
        if(snap.exists()) {
          const data = snap.val();
          rtdbContent.textContent = JSON.stringify(data, null, 2);
          
          const stats = [];
          if(path === 'root' || path === 'users') {
            const usersCount = data.users ? Object.keys(data.users).length : 0;
            stats.push(`üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${usersCount}`);
          }
          if(path === 'root' || path === 'posts') {
            const postsCount = data.posts ? Object.keys(data.posts).length : 0;
            stats.push(`üìù –ü–æ—Å—Ç–æ–≤: ${postsCount}`);
          }
          if(path === 'root' || path === 'news') {
            const newsCount = data.news ? Object.keys(data.news).length : 0;
            stats.push(`üì∞ –ù–æ–≤–æ—Å—Ç–µ–π: ${newsCount}`);
          }
          if(path === 'root' || path === 'messages' || path === 'messages_archive') {
            const messagesCount = data.messages ? Object.keys(data.messages).length : 0;
            const archiveCount = data.messages_archive ? Object.keys(data.messages_archive).length : 0;
            stats.push(`üí¨ –¢–µ–∫—É—â–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤: ${messagesCount}`);
            stats.push(`üì¶ –ê—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤: ${archiveCount}`);
          }
          
          if(stats.length > 0) {
            toast(stats.join(' ‚Ä¢ '), "info", 3000);
          }
        } else {
          rtdbContent.textContent = '{} // –î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
        }
      } catch(e) {
        rtdbContent.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`;
        toast("–û—à–∏–±–∫–∞ RTDB: " + e.message, "error", 4000);
      }
    }

    // ====== AUTH ======
    $("btnRegister").addEventListener("click", async () => {
      $("authErr").textContent = "";
      const rawU = $("authUser").value;
      const pass = $("authPass").value;

      const username = normalizeUsername(rawU);
      if(!username) return $("authErr").textContent = "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω.";
      if(pass.length < 4) return $("authErr").textContent = "–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.";

      try{
        const snap = await get(userRef(username));
        if(snap.exists()){
          $("authErr").textContent = "–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç.";
          return;
        }

        const id = "u_" + username + "_" + Date.now();
        const encryptedId = await sha256Hash(id);
        
        const encryptedData = {
          id: encryptedId,
          username: await sha256Hash(username),
          displayName: await sha256Hash(username),
          passHash: await sha256Hash(pass),
          createdAt: Date.now(),
          avatar: null,
          _original: {
            username,
            displayName: username,
            id
          }
        };
        
        await set(userRef(username), encryptedData);
        await loadUsersCache();

        saveSession({ username, id, displayName: username });
        toast("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω.", "check_circle");
        routeTo("#feed");
      }catch(e){
        $("authErr").textContent = "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.";
        toast("–û—à–∏–±–∫–∞: <b>"+escapeHtml(e.message)+"</b>", "error", 3600);
      }
    });

    $("btnLogin").addEventListener("click", async () => {
      $("authErr").textContent = "";
      const rawU = $("authUser").value;
      const pass = $("authPass").value;

      const username = normalizeUsername(rawU);
      if(!username) return $("authErr").textContent = "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω.";
      if(!pass) return $("authErr").textContent = "–ü–∞—Ä–æ–ª—å –≤–≤–µ–¥–∏.";

      try{
        const snap = await get(userRef(username));
        if(!snap.exists()){
          $("authErr").textContent = "–ù–µ—Ç —Ç–∞–∫–æ–≥–æ –ª–æ–≥–∏–Ω–∞.";
          return;
        }
        const u = snap.val();
        
        const checkPass = await sha256Hash(pass);
        if(checkPass !== u.passHash){
          $("authErr").textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.";
          return;
        }

        const displayName = u._original?.displayName || username;
        const id = u._original?.id || u.id;
        
        console.log("–í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", username, "ID:", id);
        
        saveSession({ username: u._original?.username || username, id, displayName, avatar: u.avatar || null });
        await loadUsersCache();
        
        if (u.avatar) {
          updateAvatarDisplay(u.avatar);
        } else {
          updateAvatarDisplay(null);
        }
        
        usernameInput.value = username;
        displayNameInput.value = displayName;
        
        updateUserStatus(true);
        
        toast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.", "login");
        routeTo("#feed");
      }catch(e){
        $("authErr").textContent = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞.";
        toast("–û—à–∏–±–∫–∞: <b>"+escapeHtml(e.message)+"</b>", "error", 3600);
      }
    });

    btnLogout.addEventListener("click", () => {
      updateUserStatus(false);
      clearSession();
      cleanupMessagesListeners();
      toast("–í—ã—Ö–æ–¥.", "logout");
      routeTo("#feed");
    });

    navFeed.addEventListener("click", () => routeTo("#feed"));
    navNews.addEventListener("click", () => routeTo("#news"));
    navMessages.addEventListener("click", () => routeTo("#messages"));
    navProfile.addEventListener("click", () => routeTo("#profile"));
    navRTDB.addEventListener("click", () => routeTo("#rtdb"));
    window.addEventListener("hashchange", refreshUI);

    // ====== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ ======
    btnActivateAdmin.addEventListener("click", () => {
      const token = adminTokenInput.value.trim();
      if(token === ADMIN_KEY) {
        isAdminMode = true;
        adminPanel.classList.add("hidden");
        adminStatus.classList.remove("hidden");
        toast("–ê–¥–º–∏–Ω-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!", "admin_panel_settings");
        refreshUI();
      } else {
        toast("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω!", "error");
      }
      adminTokenInput.value = "";
    });

    btnExitAdmin.addEventListener("click", () => {
      isAdminMode = false;
      adminStatus.classList.add("hidden");
      toast("–ê–¥–º–∏–Ω-—Ä–µ–∂–∏–º –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
      refreshUI();
    });

    // ====== NEWS ======
    btnPostNews.addEventListener("click", async () => {
      if(!canWriteNews()) {
        toast("–¢–æ–ª—å–∫–æ –±–æ—Ç –∏–ª–∏ –∞–¥–º–∏–Ω –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏", "error");
        return;
      }
      
      const text = newsText.value.trim();
      if(!text) return toast("–ü—É—Å—Ç–∞—è –Ω–æ–≤–æ—Å—Ç—å", "warning");
      
      btnPostNews.disabled = true;
      try {
        const now = Date.now();
        
        const encryptedNews = {
          text: await sha256Hash(text),
          authorName: await sha256Hash(sessionUser.displayName || sessionUser.username),
          authorUid: await sha256Hash(sessionUser.id),
          createdAt: now,
          isNews: true,
          _original: {
            text,
            authorName: sessionUser.displayName || sessionUser.username,
            authorUid: sessionUser.id
          }
        };
        
        await push(newsRef(), encryptedNews);
        newsText.value = "";
        toast("–ù–æ–≤–æ—Å—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞)", "newspaper");
      } catch(e) {
        toast("–û—à–∏–±–∫–∞: " + e.message, "error");
      } finally {
        btnPostNews.disabled = false;
      }
    });

    async function deleteNews(newsId) {
      if(!canDeleteNews()) {
        toast("–¢–æ–ª—å–∫–æ –±–æ—Ç –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –Ω–æ–≤–æ—Å—Ç–∏", "error");
        return false;
      }

      if(!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å?")) return false;

      try {
        await remove(ref(db, `news/${newsId}`));
        toast("–ù–æ–≤–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞", "delete");
        return true;
      } catch(e) {
        toast("–û—à–∏–±–∫–∞: " + e.message, "error");
        return false;
      }
    }

    function loadNews() {
      onValue(newsRef(), (snap) => {
        const val = snap.val() || {};
        const arr = Object.entries(val)
          .map(([key, n]) => ({ id: key, ...n }))
          .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

        newsFeed.innerHTML = "";
        if(arr.length === 0) {
          newsFeed.innerHTML = '<div class="post">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
          newsStatus.textContent = "0";
          return;
        }

        for(const item of arr) {
          const el = document.createElement("div");
          el.className = "post post--news";
          
          const author = escapeHtml(item._original?.authorName || item.authorName || "author");
          const text = escapeHtml(item._original?.text || item.text || "");
          const timeAgo = formatDateTime(item.createdAt);
          const fullTime = formatFullDateTime(item.createdAt);
          const canDelete = canDeleteNews();
          
          el.innerHTML = `
            <div class="post__head">
              <div>
                <div class="post__author">
                  <span class="badge" style="background:rgba(138,180,255,.1);">${author}</span>
                  <span class="badge badge--news"><span class="icon">newspaper</span> –ù–û–í–û–°–¢–¨</span>
                  <span class="badge badge--time" title="–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ SHA-256">
                    <span class="icon">lock</span> Encrypted
                  </span>
                </div>
                <div class="time-details">
                  <span class="badge badge--time" title="${fullTime}">
                    <span class="icon">schedule</span> ${timeAgo}
                  </span>
                </div>
              </div>
              ${canDelete ? `
                <button class="btn btn--danger delete-news-btn" data-news-id="${item.id}">
                  <span class="icon">delete</span> –£–¥–∞–ª–∏—Ç—å
                </button>
              ` : ''}
            </div>
            <div class="post__text">${text}</div>
          `;
          
          const deleteBtn = el.querySelector('.delete-news-btn');
          if(deleteBtn) {
            deleteBtn.addEventListener('click', async () => {
              await deleteNews(item.id);
            });
          }
          
          newsFeed.appendChild(el);
        }
        newsStatus.textContent = String(arr.length);
      });
    }

    btnRefreshNews.addEventListener("click", () => {
      toast("–ù–æ–≤–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã", "refresh", 900);
    });

    // ====== PROFILE ======
    async function loadProfile(){
      if(!sessionUser) return;
      
      usernameInput.value = sessionUser.username;
      displayNameInput.value = sessionUser.displayName || sessionUser.username;
      
      try {
        const snap = await get(userRef(sessionUser.username));
        const data = snap.val();
        if (data?.avatar) {
          updateAvatarDisplay(data.avatar);
          sessionUser.avatar = data.avatar;
        } else {
          updateAvatarDisplay(null);
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏", e);
      }

      if(isBotUser(sessionUser.username)) {
        adminBadgeProfile.classList.remove("hidden");
        leaguefunBadgeProfile.classList.add("hidden");
      } else if(isLegendUser(sessionUser.username)) {
        adminBadgeProfile.classList.add("hidden");
        leaguefunBadgeProfile.classList.remove("hidden");
      } else {
        adminBadgeProfile.classList.add("hidden");
        leaguefunBadgeProfile.classList.add("hidden");
      }

      try{
        const snap = await get(postsRef());
        const val = snap.val() || {};
        let cnt = 0;
        for(const k of Object.keys(val)){
          const post = val[k];
          const postUidHash = await sha256Hash(sessionUser.id);
          if (post.uid === postUidHash) cnt++;
        }
        pCount.textContent = String(cnt);
      }catch(_){
        pCount.textContent = "0";
      }
    }

    // ====== POSTS ======
    $("btnPost").addEventListener("click", async () => {
      if(!sessionUser) return toast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏.", "warning");
      const text = $("postText").value.trim();
      if(!text) return toast("–ü—É—Å—Ç–æ–π –ø–æ—Å—Ç –Ω–µ–ª—å–∑—è.", "warning");
      if(text.length > 1600) return toast("–î–æ 1600 —Å–∏–º–≤–æ–ª–æ–≤.", "warning");

      $("btnPost").disabled = true;
      try{
        const now = Date.now();
        const encryptedUid = await sha256Hash(sessionUser.id);
        
        const encryptedPost = {
          uid: encryptedUid,
          authorName: await sha256Hash(sessionUser.displayName || sessionUser.username),
          authorAvatar: sessionUser.avatar || null,
          text: await sha256Hash(text),
          pinned: false,
          createdAt: now,
          editedAt: null,
          _original: {
            authorName: sessionUser.displayName || sessionUser.username,
            text,
            uid: sessionUser.id
          }
        };
        
        await push(postsRef(), encryptedPost);
        $("postText").value = "";
        toast("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ).", "send");
      }catch(e){
        toast("–û—à–∏–±–∫–∞: <b>"+escapeHtml(e.message)+"</b>", "error", 3600);
      }finally{
        $("btnPost").disabled = false;
      }
    });

    async function deletePost(postId, postUid) {
      if(!sessionUser) {
        toast("–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏.", "warning");
        return false;
      }
      
      const userUidHash = await sha256Hash(sessionUser.id);
      const canDelete = (postUid === userUidHash) || isAdminMode;
      
      if(!canDelete) {
        toast("–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞.", "block");
        return false;
      }

      if(!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?")) return false;

      try {
        await remove(ref(db, `posts/${postId}`));
        toast("–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω.", "delete");
        return true;
      } catch(e) {
        toast("–û—à–∏–±–∫–∞: <b>"+escapeHtml(e.message)+"</b>", "error", 3600);
        return false;
      }
    }

    $("btnRefresh").addEventListener("click", () => {
      toast("–û–±–Ω–æ–≤–ª–µ–Ω–æ.", "refresh", 900);
    });

    function renderPost(key, p){
      const el = document.createElement("div");
      el.className = "post";
      
      const author = escapeHtml(p._original?.authorName || p.authorName || "user");
      const text = escapeHtml(p._original?.text || p.text || "");
      const timeAgo = formatDateTime(p.createdAt);
      const fullTime = formatFullDateTime(p.createdAt);
      const isPinned = !!p.pinned;
      
      let mine = false;
      if (sessionUser) {
        const userUidHash = sha256Hash(sessionUser.id);
        mine = p.uid === userUidHash;
      }
      
      const isAuthorBot = (p._original?.authorName || p.authorName || "").toLowerCase() === BOT_USERNAME;
      const isAuthorLegend = (p._original?.authorName || p.authorName || "").toLowerCase() === LEGEND_USERNAME;
      const edited = p.editedAt ? ` (—Ä–µ–¥. ${formatDateTime(p.editedAt)})` : '';

      let authorBadges = '';
      if(isAuthorBot) {
        authorBadges = `
          <span class="badge badge--bot"><span class="icon">smart_toy</span> –ë–û–¢</span>
          <span class="badge badge--admin"><span class="icon">verified</span> –ê–î–ú–ò–ù</span>
        `;
      } else if(isAuthorLegend) {
        authorBadges = `
          <span class="badge badge--leaguefun"><span class="icon">star</span> LEGEND</span>
        `;
      }
      if(mine && !isAuthorBot && !isAuthorLegend) {
        authorBadges += `<span class="badge"><span class="icon">person</span> —Ç—ã</span>`;
      }

      authorBadges += `<span class="badge badge--time"><span class="icon">lock</span> Encrypted</span>`;

      const canDelete = mine || isAdminMode;

      el.innerHTML = `
        <div class="post__head">
          <div class="row" style="gap:8px;">
            <div class="avatar-small">
              ${p.authorAvatar ? `<img src="${p.authorAvatar}" class="avatar-image" />` : `<div class="placeholder">${author[0]}</div>`}
            </div>
            <div>
              <div class="post__author">
                <span class="badge" style="background:rgba(138,180,255,.1);">${author}</span>
                ${authorBadges}
                ${isPinned ? `<span class="badge badge--pin"><span class="icon">push_pin</span> –ó–∞–∫—Ä–µ–ø</span>` : ``}
              </div>
              <div class="time-details">
                <span class="badge badge--time" title="–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è: ${fullTime}">
                  <span class="icon">schedule</span> ${timeAgo}${edited}
                </span>
              </div>
            </div>
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            <button class="btn btn--ghost pin-btn" data-pin>
              <span class="icon">push_pin</span> ${isPinned ? "–û—Ç–∫—Ä–µ–ø–∏—Ç—å" : "–ó–∞–∫—Ä–µ–ø–∏—Ç—å"}
            </button>
            ${canDelete ? `
              <button class="btn btn--danger delete-btn" data-delete>
                <span class="icon">delete</span> –£–¥–∞–ª–∏—Ç—å
              </button>
            ` : ''}
          </div>
        </div>
        <div class="post__text">${text}</div>
      `;

      el.querySelector('[data-pin]').addEventListener("click", async () => {
        const k = prompt("–ê–¥–º–∏–Ω-–∫–ª—é—á:");
        if(k === null) return;
        if(k !== ADMIN_KEY) return toast("–ù–µ–≤–µ—Ä–Ω–æ.", "lock");

        try{
          await update(ref(db, `posts/${key}`), { 
            pinned: !isPinned, 
            pinnedAt: Date.now() 
          });
          toast(isPinned ? "–û—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ." : "–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ.", "push_pin");
        }catch(e){
          toast("–û—à–∏–±–∫–∞: <b>"+escapeHtml(e.message)+"</b>", "error", 3600);
        }
      });

      const deleteBtn = el.querySelector('[data-delete]');
      if(deleteBtn) {
        deleteBtn.addEventListener("click", async () => {
          await deletePost(key, p.uid);
        });
      }

      return el;
    }

    // –õ–µ–Ω—Ç–∞
    function attachFeedListener(){
      onValue(postsRef(), (snap) => {
        const val = snap.val() || {};
        const arr = Object.entries(val).map(([key, p]) => ({ key, p }));

        arr.sort((a, b) => {
          const ap = !!a.p.pinned, bp = !!b.p.pinned;
          if(ap !== bp) return bp - ap;
          const at = a.p.createdAt || 0;
          const bt = b.p.createdAt || 0;
          return bt - at;
        });

        const feed = $("feed");
        feed.innerHTML = "";
        if(arr.length === 0){
          const empty = document.createElement("div");
          empty.className = "post";
          empty.textContent = "–ü–æ—Å—Ç–æ–≤ –Ω–µ—Ç.";
          feed.appendChild(empty);
          feedStatus.textContent = "0";
          return;
        }

        for(const item of arr){
          feed.appendChild(renderPost(item.key, item.p));
        }
        feedStatus.textContent = String(arr.length);
      }, (err) => {
        toast("RTDB –æ—à–∏–±–∫–∞: <b>"+escapeHtml(err?.message || "unknown")+"</b>", "error", 3600);
      });
    }

    // –ú–æ–∏ –ø–æ—Å—Ç—ã
    $("btnMyPosts").addEventListener("click", async () => {
      if(!sessionUser) return;
      const list = $("myPosts");
      const btnClear = $("btnMyPostsClear");
      list.classList.remove("hidden");
      btnClear.classList.remove("hidden");
      list.innerHTML = "";

      try{
        const snap = await get(postsRef());
        const val = snap.val() || {};
        const userUidHash = await sha256Hash(sessionUser.id);
        
        const mine = Object.entries(val)
          .map(([key, p]) => ({ key, p }))
          .filter(x => x.p?.uid === userUidHash)
          .sort((a,b) => (b.p.createdAt||0) - (a.p.createdAt||0));

        if(mine.length === 0){
          const empty = document.createElement("div");
          empty.className = "post";
          empty.textContent = "–ù–µ—Ç –ø–æ—Å—Ç–æ–≤.";
          list.appendChild(empty);
          return;
        }

        for(const it of mine){
          list.appendChild(renderPost(it.key, it.p));
        }
      }catch(e){
        toast("–û—à–∏–±–∫–∞: <b>"+escapeHtml(e.message)+"</b>", "error", 3600);
      }
    });

    $("btnMyPostsClear").addEventListener("click", () => {
      $("myPosts").classList.add("hidden");
      $("btnMyPostsClear").classList.add("hidden");
      $("myPosts").innerHTML = "";
    });

    // ====== UI STATE ======
    function refreshUI(){
      statusDb.innerHTML = `<span class="icon">database</span> RTDB: <b>ok (SHA-256)</b>`;

      btnLogout.classList.toggle("hidden", !sessionUser);
      
      if(isAdminMode) {
        adminStatus.classList.remove("hidden");
      } else {
        adminStatus.classList.add("hidden");
      }

      if(sessionUser && isBotUser(sessionUser.username)) {
        navRTDB.classList.remove("hidden");
        botStatus.classList.remove("hidden");
      } else {
        navRTDB.classList.add("hidden");
        botStatus.classList.add("hidden");
      }

      if(sessionUser && isLegendUser(sessionUser.username)) {
        leaguefunStatus.classList.remove("hidden");
      } else {
        leaguefunStatus.classList.add("hidden");
      }

      if(sessionUser) {
        navMessages.classList.remove("hidden");
      } else {
        navMessages.classList.add("hidden");
      }

      if(!sessionUser){
        statusAuth.innerHTML = `<span class="icon">key</span> –ì–æ—Å—Ç—å`;
        showOnly("auth");
        return;
      }

      let authHtml = '';
      if (sessionUser.avatar) {
        authHtml = `<div class="avatar-small"><img src="${sessionUser.avatar}" class="avatar-image" /></div>`;
      } else {
        const initial = (sessionUser.displayName || sessionUser.username)[0];
        authHtml = `<div class="avatar-small"><div class="placeholder">${initial.toUpperCase()}</div></div>`;
      }
      
      if(isBotUser(sessionUser.username)) {
        statusAuth.innerHTML = authHtml + ` <span class="icon">verified</span> <b>${escapeHtml(sessionUser.displayName || sessionUser.username)}</b> <span class="badge badge--bot">–ë–û–¢</span> <span class="badge badge--time"><span class="icon">lock</span> Encrypted</span>`;
      } else if(isLegendUser(sessionUser.username)) {
        statusAuth.innerHTML = authHtml + ` <span class="icon">star</span> <b>${escapeHtml(sessionUser.displayName || sessionUser.username)}</b> <span class="badge badge--leaguefun">LEGEND</span> <span class="badge badge--time"><span class="icon">lock</span> Encrypted</span>`;
      } else {
        statusAuth.innerHTML = authHtml + ` <span class="icon">verified_user</span> <b>${escapeHtml(sessionUser.displayName || sessionUser.username)}</b> <span class="badge badge--time"><span class="icon">lock</span> Encrypted</span>`;
      }

      const r = currentRoute();
      showOnly(r);

      if(r === "feed") {
        if(!isAdminMode) {
          adminPanel.classList.remove("hidden");
        } else {
          adminPanel.classList.add("hidden");
        }
      }
      
      if(r === "news") {
        if(canWriteNews()) {
          newsFormContainer.classList.remove("hidden");
        } else {
          newsFormContainer.classList.add("hidden");
        }
      }
      
      if(r === "messages") {
        loadDialogs();
        if (!currentChat) {
          chatContainer.classList.add("hidden");
          noChatSelected.classList.remove("hidden");
        }
      }
      
      if(r === "profile") {
        loadProfile();
      }
      if(r === "rtdb") {
        if(!sessionUser || !isBotUser(sessionUser.username)) {
          toast("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", "error");
          routeTo("#feed");
        } else {
          loadRTDBData('root');
        }
      }
    }

    // ====== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ======
    function randomSalt(len=16){
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return btoa(String.fromCharCode(...arr)).replaceAll("=", "").slice(0, 22);
    }

    function normalizeUsername(u){
      return u.trim().toLowerCase().replace(/[^a-z0-9_\.]/g, "");
    }

    function formatDateTime(ms){
      if(!ms) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
      const d = new Date(ms);
      const now = new Date();
      const diff = Math.floor((now - d) / 1000);
      
      if (diff < 60) return "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
      if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      if (diff < 86400) return `${Math.floor(diff / 3600)} —á –Ω–∞–∑–∞–¥`;
      
      return new Intl.DateTimeFormat("ru-RU", { 
        day: 'numeric', 
        month: 'short', 
        hour: '2-digit', 
        minute: '2-digit' 
      }).format(d);
    }

    function formatFullDateTime(ms){
      if(!ms) return "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      return new Intl.DateTimeFormat("ru-RU", { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      }).format(new Date(ms));
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ RTDB
    btnLoadRTDB.addEventListener("click", () => {
      loadRTDBData(rtdbPath.value);
    });

    btnRefreshRTDB.addEventListener("click", () => {
      loadRTDBData(rtdbPath.value);
    });

    btnRefreshMessages.addEventListener("click", () => {
      loadDialogs();
      toast("–î–∏–∞–ª–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã", "refresh", 900);
    });

    // –°—Ç–∞—Ä—Ç
    const s = loadSession();
    if(s) sessionUser = s;
    await loadUsersCache();
    attachFeedListener();
    loadNews();
    refreshUI();
    if (sessionUser) {
      updateUserStatus(true);
      if (sessionUser.avatar) {
        updateAvatarDisplay(sessionUser.avatar);
      }
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Ä—Ö–∏–≤–∞—Ü–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      archiveOldMessages();
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Ä—Ö–∏–≤–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞
      setInterval(archiveOldMessages, 24 * 60 * 60 * 1000);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏
    window.addEventListener("beforeunload", () => {
      if (sessionUser) {
        updateUserStatus(false);
      }
      cleanupMessagesListeners();
    });
  </script>
</body>
</html>
